import { IntegrationHandler } from "@netlify/integrations";
import { connect, Connection } from "@planetscale/database";
import nodeFetch from "node-fetch";

export interface PlanetScaleContext {
  planetscale: {
    connection: Connection;
  };
}

export const withPlanetscale: IntegrationHandler<PlanetScaleContext> = (
  handler
) => {
  let connection: Connection;

  connection = connect({
    host: process.env.PLANETSCALE_HOST,
    password: process.env.PLANETSCALE_PASSWORD,
    username: process.env.PLANETSCALE_USERNAME,
    fetch: typeof fetch === "undefined" ? nodeFetch : fetch,
  });

  return async (event, context) => {
    return handler(event, { ...context, planetscale: { connection } });
  };
};
